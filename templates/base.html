<!DOCTYPE html>
<html lang="es">
    <head>
        
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
        
    <title>{% block title %}{% endblock %}</title>
    
    {% load staticfiles %}    
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'media/image/favicon2.ico' %}">
    <!-- Bootstrap core CSS-->
    <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css">
        
    <!-- Custom fonts for this template-->
    <link href="{% static 'vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">
        
    <!-- Page level plugin CSS-->
    <link href="{% static 'vendor/datatables/dataTables.bootstrap4.css' %}" rel="stylesheet" type="text/css">
        
    <!-- Custom styles for this template-->
    <link href="{% static 'css/sb-admin.css' %}" rel="stylesheet" type="text/css">
</head>
<body>
    <div id="page-top" style="background-color: #fbfcff !important">
        {% block header %}
        {% endblock header %}
        <div id="wrapper">
        {% block content %}
            {% block sidebar %}
            {% endblock sidebar %}
            {% block tables %}
            {% endblock tables %}
            {% block modals %}
            {% endblock modals %}
        {% endblock content %}
        </div>
        {% block footer %}
        {% endblock footer %}
        <script>
            function redirect(url){
                location.href=url
            };
            function operacion(id, nombre, url, type, caso){       
                console.log("OPERACION: "+type);
                switch(type){
                case 'GET':
                    header = "Visualizar "+caso+": ";
                    body = null;
                    footer = "<button class='btn btn-primary' type='button' data-dismiss='modal'>Cancelar</button>"+
                    "<button id='confirmacion' class='btn btn-danger' href='#'>Editar</button>";
                    //enable();
                    cargarModal(nombre, header, body, footer);
                    ejecutarAJAX(id, url, type);
                    $('#detalleModal').modal('show');
                    header = "Editar "+caso+": ";
                    body = $('#detalle').contents();
                    footer = "<button class='btn btn-primary' type='button' data-dismiss='modal'>Cancelar</button>"+
                    "<button id='confirmacion' class='btn btn-danger' href='#'>Guardar</button>";
                    $('#confirmacion').attr('onclick', 'enable()');
                    $('#detalleModal').modal('hide');
                    cargarModal(nombre, header, body, footer);
                    $('#detalleModal').modal('show');
                    $('#confirmacion').attr('onclick', 'confirmarAccion('+nombre+', '+header+', '+body+', '+footer+')')
                    $('#detalleModal').modal('hide');
                    $('#confirmacion').attr('onclick', 'ejecutarAJAX('+id+',\''+url+'\',\'PUT\')');
                    $('#detalleModal').modal('hide');
                    break;
                case 'LOAD':
                    header = "Guardar "+caso+": ";
                    body = null;
                    footer = "<button class='btn btn-primary' type='button' data-dismiss='modal'>Cancelar</button>"+
                    "<button id='confirmacion' class='btn btn-danger' href='#'>Guardar</button>";
                    enable();
                    cargarModal(nombre, header, body, footer);
                    ejecutarAJAX(id, nombre, url, 'GET');
                    $('#detalleModal').modal('show');
                    $('#confirmacion').attr('onclick', 'confirmarAccion('+nombre+', '+header+', '+body+', '+footer+')')
                    $('#detalleModal').modal('hide');
                    $('#confirmacion').attr('onclick', 'ejecutarAJAX('+id+',\''+url+'\',\'PUT\')');
                    $('#detalleModal').modal('hide');
                    break;
                case 'DELETE':
                    header = "Eliminar "+caso+": ";
                    body = "<p>¿Seguro que desea eliminar el "+caso+" <strong>"+nombre+"</strong>?</p>"+
                    "<p>Seleccione 'Continuar' para confirmar la acción</p>";
                    footer = "<button class='btn btn-primary' type='button' data-dismiss='modal'>Cancelar</button>"+
                    "<button id='confirmacion' class='btn btn-danger' href='#'>Continuar</button>";
                    confirmarAccion(nombre, header, body, footer);
                    $('#confirmacion').attr('onclick', 'ejecutarAJAX('+id+',\''+url+'\',\''+type+'\')');
                    break;
                };
            };

            function cargarModal(nombre, header, body, footer){
              console.log('CARGARMODAL: '+nombre);
                $('#modalHeader').empty();
                $('#modalHeader').append(
                "<strong>"+header+nombre+"</strong>"
                );
                $('#modalBody').empty();
                $('#modalBody').append(
                body
                );
                $('#modalFooter').empty();
                $('#modalFooter').append(
                footer
                );
                $('#detalle').empty();
            };

            function confirmarAccion(nombre, header, body, footer){
                console.log("CONFIRMARACCION: "+nombre);
                $('#modalHeader').empty();
                $('#modalHeader').append(
                "<strong>"+header+nombre+"</strong>"
                );
                $('#modalBody').empty();
                $('#modalBody').append(
                body
                );
                $('#modalFooter').empty();
                $('#modalFooter').append(
                footer
                );
                $('#detalleModal').modal('show');
            };

            function ejecutarAJAX(id, url, type){
                console.log("EJECUTARAJAX: "+type);
                result = ajaxOperacion(id, url, type);
                switch(type){
                case 'GET':
                    result.done(function(data){
                      alert(data)
                      $('#visualizarModal').modal('show');
                      load(
                          data,
                          '#detalle'
                      );
                    }).fail(function(data){
                      //alert(data.message)
                      console.log("error");
                    }).always(function(){
                      console.log("complete");
                    });
                    break;
                case 'PUT':
                    result.done(function(data){
                      alert(data.message)
                      $('#detalleModal').modal('hide');
                    }).fail(function(data){
                    alert(data.message)
                      console.log("error");
                      $('#detalleModal').modal('hide')
                    }).always(function(respuesta){
                      console.log("complete");
                    });
                    break;
                case 'DELETE':
                    result.done(function() {
                      alert("Se efectuó el borrado exitosamente");
                      $('#detalleModal').modal('hide');
                      $('#'+id).remove();
                    }).fail(function() {
                      console.log("error");
                      alert("El borrado no pudo ser ejecutado");
                      $('#detalleModal').modal('hide');
                    }).always(function() {
                      console.log("complete");
                    });
                    break;
                }

            };

            function ajaxOperacion(id, url, type){
              console.log("AJAX: "+type);
                return $.ajax({
                    url: url,
                    type: type,
                    data: {
                    'id': id,
                    },
                    success: function(data){
                        alert(data);
                      $('#detalle').load(
                        data.invernadero, '#detalle'
                      );
                      console.log("SUCCES");
                    },
                    dataType: 'json'
                });
            };
            $(function () {
                $.ajaxSetup({
                    headers: { "X-CSRFToken": getCookie("csrftoken") }
                });
            });
        
        </script>
        <!-- Bootstrap core JavaScript-->
        <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
        <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

        <!-- Core plugin JavaScript-->
        <script src="{% static 'vendor/jquery-easing/jquery.easing.min.js' %}"></script>

        <!-- Page level plugin JavaScript-->
        <script src="{% static 'vendor/datatables/jquery.dataTables.js' %}"></script>
        <script src="{% static 'vendor/datatables/dataTables.bootstrap4.js' %}"></script>

        <!-- Custom scripts for all pages-->
        <script src="{% static 'js/sb-admin.min.js' %}"></script>
        <script src="{% static 'js/invernaderos.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/csrf.js' %}"></script>

        <!-- Demo scripts for this page-->
        <script src="{% static 'js/demo/datatables-demo.js' %}"></script>
    </div>
    <!--VIEW, EDIT & DELETE MODAL-->
    <div class="modal fade" id="detalleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title bold" id="modalHeader"></h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div id="modalBody" class="modal-body">
                  <form action="" method="POST" id="detalle">
                    {% csrf_token %}
                    {{ data.form }}
                  </form>
                </div>
                <div id="modalFooter" class="modal-footer">
                </div>
            </div> 
        </div>
    </div>
    <!--LOGOUT MODAL-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">¿Seguro que quieres cerrar la sesión?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Seleccione "Cerrar sesión" a continuación si está listo para finalizar su sesión actual</div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                        <a class="btn btn-primary" href="{% url 'invernaderos:sign-out' %}">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>