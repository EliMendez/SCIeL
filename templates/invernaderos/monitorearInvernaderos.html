{% extends 'header&footer.html' %}
{% block title %}SCIeL - Monitorear Invernaderos{% endblock title %}

{% block content %}
    
  {% block sidebar %}
  {% if user.is_authenticated %}
    <!-- Sidebar -->
    <ul class="sidebar navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'invernaderos:dispositivos' %}">
          <i class="fas fa-fw fa-cubes"></i>
          <span>Dispositivos</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'invernaderos:sensores' %}">
          <i class="fas fa-fw fa-thermometer-quarter"></i>
          <span>Sensores</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'invernaderos:actuadores' %}">
          <i class="fas fa-fw fa-wrench"></i>
            <span>Actuadores</span>
        </a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="{% url 'invernaderos:invernaderos' %}">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Invernaderos</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'invernaderos:cultivos' %}">
          <i class="fas fa-fw fa-leaf"></i>
          <span>Cultivos</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'invernaderos:parametros' %}">
          <i class="fas fa-fw fa-cogs"></i>
          <span>Par치metros Est치ndar</span>
        </a>
      </li>
    </ul>
  {% endif %}
  {% endblock sidebar %}
  <div id="content-wrapper">
      <div class="container-fluid">
        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="#">Servicios</a>
          </li>
          <li class="breadcrumb-item active">Mediciones</li>
        </ol>
        <!-- Icon Cards-->
        <div class="row bold">
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:dispositivos' %}')">
            <div class="card text-white bg-primary o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-cubes"></i>
                </div>
                <div class="mr-5">{{cant_dispositivos}} Dispositivos</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:invernaderos' %}')">
            <div class="card text-white bg-warning o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-tachometer-alt"></i>
                </div>
                <div class="mr-5">{{cant_invernaderos}} Invernaderos</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:cultivos' %}')">
            <div class="card text-white bg-success o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-leaf"></i>
                </div>
                <div class="mr-5">{{cant_cultivos}} Cultivos</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:sensores' %}')">
            <div class="card text-white bg-danger o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-thermometer-quarter"></i>
                </div>
                <div class="mr-5">{{cant_sensores}} Sensores</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:actuadores' %}')">
            <div class="card text-white bg-secondary o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-wrench"></i>
                </div>
                <div class="mr-5">{{cant_actuadores}} Actuadores</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
          <div class="col-xl-4 col-sm-6 mb-4" onclick="redirect('{% url 'invernaderos:parametros' %}')">
            <div class="card text-white bg-info o-hidden h-100">
              <div class="card-body">
                <div class="card-body-icon">
                  <i class="fas fa-fw fa-cogs"></i>
                </div>
                <div class="mr-5">{{cant_parametros}} Par치metros Est치ndar</div>
              </div>
              <a class="card-footer text-white clearfix small z-1" href="#">
                <span class="float-left">Ver Detalles</span>
                <span class="float-right">
                  <i class="fas fa-angle-right"></i>
                </span>
              </a>
            </div>
          </div>
        </div>

        <div id="bodyChart">
          {% include 'invernaderos/bodyChart.html' %}
        </div>

        </div>
        <!-- /.container-fluid -->
        <!-- Sticky Footer -->
      </div>
      <!-- /.content-wrapper -->
    </div>
    <!-- /#wrapper -->
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <script>
      
      var lb1 = []
      var data1 = []
      var lb2 = []
      var data2 = []
      var lb3 = []
      var data3 = []
      
      window.onload=function(){
        loadData();
      }

      function loadChart(idCanvas, data, lbl){
          var ctx = document.getElementById(idCanvas).getContext('2d');
          var myLineChart = new Chart(
            ctx, 
            {
              type: 'line',
              data: {
                labels: lbl,
                datasets: [{
                  data: data,
                  backgroundColor: "rgba(2,117,216,0.2)",
                  borderColor: "rgba(2,117,216,1)",
                  pointRadius: 5,
                  pointBackgroundColor: "rgba(2,117,216,1)",
                  pointBorderColor: "rgba(255,255,255,0.8)",
                  pointHoverRadius: 5,
                  pointHoverBackgroundColor: "rgba(2,117,216,1)",
                  pointHitRadius: 50,
                  pointBorderWidth: 2,
                }]
              },
              options: {
                scales: {
                  xAxes: [{
                    time: {
                      unit: 'date'
                    },
                    gridLines: {
                      display: true
                    },
                    ticks: {
                      maxTicksLimit: 7
                    }
                  }],
                  yAxes: [{
                    ticks: {
                      min: 0,
                      maxTicksLimit: 5
                    },
                    gridLines: {
                      color: "rgba(0, 0, 0, .125)",
                    }
                  }],
                },
                legend: {
                  display: true
                }
              }
          })
        }

      setInterval(function(){
          console.log("Iniciando");
          $.ajax({
            url: "{% url 'invernaderos:ajax-datos' %}",
            type: 'GET',
            data: {
              'id_invernadero': {{ id_invernadero }}
            },
            success: function(data){
              console.log(data);
              console.log("SUCCES");
            },
            dataType: 'json'
          }).done(function(data) {
            loadChart("humedadAireChart", data.relativas_magnitud, data.relativas_fecha);
            loadChart("humedadSueloChart", data.suelo_magnitud, data.suelo_fecha);
            loadChart("temperaturaChart", data.temp_magnitud, data.temp_fecha);
            $(".data").empty();
            $(".data").append(data.fecha+9)
          }).fail(function() {
            console.log("error");
          }).always(function() {
            console.log("complete");
          });
          console.log("Terminando");
        }, 5000);

      function loadData(){
        console.log("Iniciando");
        $.ajax({
          url: "{% url 'invernaderos:ajax-datos' %}",
          type: 'GET',
          data: {
            'id_invernadero': {{ id_invernadero }}
          },
          success: function(data){
            console.log(data);
            console.log("SUCCES");
          },
          dataType: 'json'
        }).done(function(data) {
          loadChart("humedadAireChart", data.relativas_magnitud, data.relativas_fecha);
          loadChart("humedadSueloChart", data.suelo_magnitud, data.suelo_fecha);
          loadChart("temperaturaChart", data.temp_magnitud, data.temp_fecha);
          $(".data").empty();
          $(".data").append(data.fecha+9)
        }).fail(function() {
          console.log("error");
        }).always(function() {
          console.log("complete");
        });
        console.log("Terminando");
      };
      
    </script>
{% endblock content %}
{% block script %}
{% endblock script %}
